#!/usr/bin/env bash

# Absolute path
BIN_DIR=$(cd $(dirname $0) && pwd)

BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
INDEX=$4

source ${BIN_DIR}/../vars.sh

echo "[INFO] Installing Java"
wget --no-check-certificate -q -c \
        --header "Cookie: oraclelicense=accept-securebackup-cookie" \
        ${JRE_URL} -O ${BIN_DIR}/jre.zip

mkdir ${BUILD_DIR}/.java

# Unpack jre content directly to .java in BUILD_DIR
# -C is the directory, strip-components removes the top-level folder (jre_1.8.....)
tar zxf ${BIN_DIR}/jre.zip -C ${BUILD_DIR}/.java --strip-components 1

echo "[INFO] Installing Waratek Secure"
if [ -z ${WARATEK_VERSION+x} ];
then
    echo "[ERROR] WARATEK_VERSION is not set. Please add it to the 'env' section of your manifest.yml file (e.g. WARATEK_VERSION: \"19.0.0\")."
    exit 1
fi

wget "$WARATEK_DIST_URL/$WARATEK_ZIP" -O ${BIN_DIR}/waratek-secure.zip --no-check-certificate -q
unzip -q ${BIN_DIR}/waratek-secure.zip -d ${BUILD_DIR}
mv ${BUILD_DIR}/waratek-secure-${WARATEK_VERSION} ${BUILD_DIR}/waratek-secure
